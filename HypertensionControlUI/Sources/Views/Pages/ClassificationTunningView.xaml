<views:PageViewBase x:TypeArguments="viewModels:ClassificationTunningViewModel"
                    x:Class="HypertensionControlUI.Views.Pages.ClassificationTunningView"
                    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                    xmlns:views="clr-namespace:HypertensionControlUI.Views"
                    xmlns:viewModels="clr-namespace:HypertensionControlUI.ViewModels"
                    xmlns:converters="clr-namespace:HypertensionControlUI.Views.Converters"
                    xmlns:components="clr-namespace:HypertensionControlUI.Sources.Views.Components"
                    xmlns:system="clr-namespace:System;assembly=mscorlib"
                    xmlns:models="clr-namespace:HypertensionControlUI.Models"
                    mc:Ignorable="d"
                    d:DataContext="{d:DesignInstance Type=viewModels:ClassificationTunningViewModel, IsDesignTimeCreatable=False}"
                    d:DesignHeight="500" d:DesignWidth="500"
                    Title="ClassificationTunning">

    <FrameworkElement.Resources>
        <Style x:Key="HeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20" />
            <Setter Property="Margin" Value="0,8" />
        </Style>
    </FrameworkElement.Resources>

    <Border>
        <DockPanel>

            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal">
                <Button Command="{Binding ShowPatientCommand}" Margin="3" Padding="8,4">
                    <StackPanel Orientation="Horizontal">
                        <Image Source="/Resources/Markup/Icons/back.png" Width="16" Height="16" Margin="0,0,8,0" />
                        <TextBlock Text="Назад к индивидуальной карте" />
                    </StackPanel>
                </Button>
                <Button Command="{Binding PatientsCommand}" Margin="3" Padding="8,4">
                    <StackPanel Orientation="Horizontal">
                        <Image Source="/Resources/Markup/Icons/go-first.png" Width="16" Height="16" Margin="0,0,8,0" />
                        <TextBlock Text="Вернуться к списку пациентов" />
                    </StackPanel>

                </Button>
            </StackPanel>

            <Grid Margin="3">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Grid.Resources>
                    <converters:EqualityConverter x:Key="NotNullEqualityConverter" True="false" False="true" />
                </Grid.Resources>

                <Border Grid.Row="1">
                    <StackPanel>
                        <TextBlock Style="{StaticResource HeaderStyle}" Text="Модели для классификации пациента" />
                        <Grid MinHeight="120">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition />
                            </Grid.ColumnDefinitions>
                            <ListBox Grid.Column="0" FontSize="14"
                                     ItemsSource="{Binding AvailableClassificationModels}"
                                     SelectedItem="{Binding SelectedClassificationModel, Mode=TwoWay}">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" TextWrapping="Wrap" Margin="2" />
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                            <Border Grid.Column="1" Style="{StaticResource BlockStyle}" Margin="8,0" Padding="8">
                                <TextBlock FontSize="14" TextWrapping="Wrap" Text="{Binding SelectedClassificationModel.Description}" />
                            </Border>
                        </Grid>
                    </StackPanel>
                </Border>

                <Border Grid.Row="2">
                    <StackPanel>
                        <TextBlock Style="{StaticResource HeaderStyle}" Text="Прогноз" />

                        <StackPanel TextBlock.FontSize="14" Orientation="Horizontal" Margin="32,8,0,0">
                            <TextBlock Margin="0,0,16,0">
                                <Run Foreground="DimGray" Text="Вероятность болезни:" />
                                <Run Text="{Binding Result, StringFormat={}{0:f3}}" />
                            </TextBlock>
                            <TextBlock>
                                <Run Foreground="DimGray" Text="Оптимальный порог отсечения:" />
                                <Run Text="{Binding SelectedClassificationModel.OptimalCutOff}" />
                            </TextBlock>
                        </StackPanel>

                        <components:IllnessProbabilityChart Height="70" Margin="32,0"
                                                            ThumbValue="{Binding Result}"
                                                            CutOffValue="{Binding SelectedClassificationModel.OptimalCutOff}" />


                        <TextBlock Style="{StaticResource HeaderStyle}" Margin="5">Возможная коррекция</TextBlock>

                        <ListView Margin="32,5" FontSize="14"
                                  HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch"
                                  ItemsSource="{Binding CorrectableProperties}" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                </Style>
                            </ListView.ItemContainerStyle>
                            <ListView.View>
                                <GridView>
                                    <GridView.ColumnHeaderContainerStyle>
                                        <Style TargetType="{x:Type GridViewColumnHeader}">
                                            <Setter Property="IsEnabled" Value="False" />
                                            <Style.Triggers>
                                                <Trigger Property="IsEnabled" Value="False">
                                                    <Setter Property="TextElement.Foreground" Value="Black" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </GridView.ColumnHeaderContainerStyle>
                                    <GridViewColumn Header="Фактор" Width="120" DisplayMemberBinding="{Binding Path=Key, Converter={StaticResource FactorsConverter}}" />
                                    <GridViewColumn Header="Текущее значение" Width="240">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate DataType="viewModels:CorrectablePatientPropertyViewModel">
                                                <ContentControl Content="{Binding OriginalValue, Mode=OneTime}" HorizontalAlignment="Stretch">
                                                    <ContentControl.Resources>
                                                        <DataTemplate DataType="{x:Type system:Double}">
                                                            <TextBlock Text="{Binding Path=.}" TextAlignment="Right" />
                                                        </DataTemplate>
                                                        <DataTemplate DataType="{x:Type system:Int32}">
                                                            <TextBlock Text="{Binding Path=.}" TextAlignment="Right" />
                                                        </DataTemplate>
                                                        <DataTemplate DataType="{x:Type models:PhysicalActivity}">
                                                            <TextBlock Text="{Binding Path=., Converter={StaticResource PhysicalActivityConverter}}" TextAlignment="Right" />
                                                        </DataTemplate>
                                                    </ContentControl.Resources>
                                                </ContentControl>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Новое значение" Width="250">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate DataType="viewModels:CorrectablePatientPropertyViewModel">
                                                <ContentControl Content="{Binding CorrectedValue, Mode=TwoWay}" HorizontalAlignment="Stretch">
                                                    <ContentControl.Resources>
                                                        <DataTemplate DataType="{x:Type system:Double}">
                                                            <TextBox
                                                                Text="{Binding RelativeSource={RelativeSource AncestorType=ContentControl}, Path=Content, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                                Cursor="Hand" HorizontalAlignment="Stretch" TextAlignment="Right" />
                                                        </DataTemplate>
                                                        <DataTemplate DataType="{x:Type system:Int32}">
                                                            <TextBox
                                                                Text="{Binding RelativeSource={RelativeSource AncestorType=ContentControl}, Path=Content, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                                Cursor="Hand" HorizontalAlignment="Stretch" TextAlignment="Right" />
                                                        </DataTemplate>
                                                        <DataTemplate DataType="{x:Type models:PhysicalActivity}">
                                                            <ComboBox ItemsSource="{Binding Source={StaticResource PhysicalActivityProvider}}"
                                                                      SelectedItem="{Binding RelativeSource={RelativeSource AncestorType=ContentControl}, Path=Content, Mode=TwoWay}"
                                                                      HorizontalAlignment="Stretch" HorizontalContentAlignment="Right">
                                                                <ComboBox.ItemTemplate>
                                                                    <DataTemplate>
                                                                        <TextBlock Text="{Binding Path=., Converter={StaticResource PhysicalActivityConverter}}"
                                                                                   TextAlignment="Right" />
                                                                    </DataTemplate>
                                                                </ComboBox.ItemTemplate>
                                                            </ComboBox>
                                                        </DataTemplate>

                                                    </ContentControl.Resources>
                                                </ContentControl>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                </GridView>
                            </ListView.View>
                        </ListView>

                        <TextBlock Style="{StaticResource HeaderStyle}" Margin="5">Прогноз после коррекции</TextBlock>

                        <Button HorizontalAlignment="Left"
                                Command="{Binding ClassifyPossiblePatientCommand}"
                                IsEnabled="{Binding SelectedClassificationModel, Converter={StaticResource NotNullEqualityConverter}, ConverterParameter={x:Null}, Mode=OneWay}">
                            <TextBlock Text="Спрогнозировать вероятность болезни после коррекции" />
                        </Button>

                        <StackPanel TextBlock.FontSize="14" Orientation="Horizontal" Margin="32,8,0,0">
                            <TextBlock Margin="0,0,16,0">
                                <Run Foreground="DimGray" Text="Вероятность болезни:" />
                                <Run Text="{Binding CorrectedResult, StringFormat={}{0:f3}}" />
                            </TextBlock>
                        </StackPanel>

                        <components:IllnessProbabilityChart Height="70" Margin="32,0"
                                                            ThumbValue="{Binding CorrectedResult}"
                                                            CutOffValue="{Binding SelectedClassificationModel.OptimalCutOff}" />


                    </StackPanel>
                </Border>

            </Grid>
        </DockPanel>
    </Border>

</views:PageViewBase>